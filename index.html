<<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Storage System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <div id="loadingIndicator" class="absolute inset-0 flex items-center justify-center bg-gray-200 bg-opacity-75 z-50 hidden">
        <svg class="animate-spin -ml-1 mr-3 h-10 w-10 text-gray-700" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
    </div>

    <div id="modal-backdrop" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden z-40"></div>
    <div id="message-modal" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white rounded-lg shadow-xl p-6 hidden z-50 w-full max-w-sm mx-auto">
        <div class="text-center">
            <h3 id="modal-title" class="text-lg font-semibold text-gray-900 mb-2"></h3>
            <p id="modal-message" class="text-sm text-gray-500 mb-4"></p>
            <button id="modal-close-button" class="mt-2 px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Close</button>
        </div>
    </div>

    <main class="w-full max-w-4xl bg-white rounded-xl shadow-2xl p-6 sm:p-8 flex flex-col space-y-6">

        <!-- Header and User Info Section -->
        <header class="flex flex-col sm:flex-row justify-between items-center pb-4 border-b border-gray-200">
            <div class="flex items-center space-x-3 mb-4 sm:mb-0">
                <img src="https://placehold.co/60x60/a855f7/ffffff?text=IS" alt="App Logo" class="h-14 w-14 rounded-full">
                <h1 class="text-3xl font-bold text-gray-800">Image System</h1>
            </div>
            <div id="user-info-container" class="flex flex-col items-center sm:items-end space-y-2 sm:space-y-0 sm:space-x-3 transition-opacity duration-300 hidden">
                <div class="flex items-center space-x-3">
                    <span id="user-name" class="text-gray-700 font-medium"></span>
                    <img id="user-photo" class="h-10 w-10 rounded-full border-2 border-indigo-500" alt="User Photo">
                    <button id="logout-button" class="px-4 py-2 bg-rose-500 text-white font-medium rounded-full shadow hover:bg-rose-600 transition-colors">Logout</button>
                </div>
                <p id="user-id-display" class="text-sm text-gray-500 mt-2 sm:mt-0"></p>
            </div>
        </header>

        <!-- Authentication and Main Content -->
        <section id="auth-section" class="flex flex-col items-center justify-center space-y-6 py-12 transition-opacity duration-300">
            <h2 class="text-2xl font-semibold text-gray-700">Sign in to get started</h2>
            <button id="google-signin-button" class="flex items-center space-x-2 px-6 py-3 bg-white text-gray-700 font-medium rounded-full shadow-lg hover:shadow-xl transition-shadow border border-gray-300">
                <svg class="h-6 w-6" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                    <path d="M22.0001 12.1931C22.0001 11.4581 21.9361 10.7441 21.8051 10.0481H11.7581V14.0721H17.6531C17.3881 15.4221 16.5681 16.5791 15.4401 17.3441V20.0891H19.0061C21.0841 18.2711 22.0001 15.4221 22.0001 12.1931Z" fill="#4285F4"></path>
                    <path d="M11.7581 22.0001C14.7571 22.0001 17.3091 21.0111 19.0061 19.3441L15.4401 17.3441C14.4751 18.0121 13.2321 18.4111 11.7581 18.4111C9.09714 18.4111 6.84014 16.5881 6.01214 14.1751H2.38714V16.9201C4.16214 20.3011 7.64414 22.0001 11.7581 22.0001Z" fill="#34A853"></path>
                    <path d="M6.01219 14.1751C5.79919 13.5181 5.68419 12.8361 5.68419 12.1931C5.68419 11.5501 5.79919 10.8681 6.00219 10.2111V7.46613H2.38719C1.65019 8.90013 1.25819 10.5101 1.25819 12.1931C1.25819 13.8761 1.65019 15.4861 2.38719 16.9201L6.01219 14.1751Z" fill="#FBBC04"></path>
                    <path d="M11.7581 5.86712C13.4381 5.86712 14.9391 6.46712 16.1261 7.60412L19.0991 4.75512C17.3091 3.03312 14.7571 2.00012 11.7581 2.00012C7.64412 2.00012 4.16212 3.70012 2.38712 7.08112L6.00212 9.82612C6.84012 7.41312 9.09712 5.86712 11.7581 5.86712Z" fill="#EA4335"></path>
                </svg>
                <span>Sign in with Google</span>
            </button>
        </section>

        <!-- Main App Section (Image Upload and Gallery) -->
        <section id="app-section" class="flex flex-col space-y-6 hidden">
            <!-- Image Upload Form -->
            <div class="bg-gray-50 rounded-lg p-6 flex flex-col sm:flex-row items-center space-y-4 sm:space-y-0 sm:space-x-4 border border-gray-200 shadow-inner">
                <input type="file" id="image-file" accept="image/*" class="w-full sm:w-auto text-gray-700 font-medium px-4 py-2 bg-white rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <button id="upload-button" class="w-full sm:w-auto flex-shrink-0 px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow hover:bg-indigo-700 transition-colors">
                    Upload Image
                </button>
            </div>

            <!-- Image Gallery -->
            <div class="flex-1 p-4 bg-gray-50 rounded-lg border border-gray-200 shadow-inner overflow-y-auto max-h-[70vh]">
                <h3 class="text-xl font-semibold text-gray-700 mb-4">Your Image Gallery</h3>
                <div id="gallery-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Images will be dynamically added here -->
                </div>
                <div id="no-images-message" class="text-center text-gray-500 py-12 hidden">
                    No images uploaded yet.
                </div>
            </div>
        </section>
    </main>

    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Set Firebase logging level for debugging
        setLogLevel('debug');

        // Your web app's Firebase configuration for GitHub Pages
        const firebaseConfig = {
            apiKey: "AIzaSyA6UCcHctuccO8O6VhJ4jTbKycrby_5hHk",
            authDomain: "imagestoring-f5d2e.firebaseapp.com",
            projectId: "imagestoring-f5d2e",
            storageBucket: "imagestoring-f5d2e.firebasestorage.app",
            messagingSenderId: "380259379403",
            appId: "1:380259379403:web:89e8d32de3d8ebeec8934e",
            measurementId: "G-Q5X8S3X2ZH"
        };

        // --- Firebase Initialization ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        // --- UI Element References ---
        const authSection = document.getElementById('auth-section');
        const appSection = document.getElementById('app-section');
        const signInButton = document.getElementById('google-signin-button');
        const logoutButton = document.getElementById('logout-button');
        const uploadButton = document.getElementById('upload-button');
        const imageFile = document.getElementById('image-file');
        const galleryContainer = document.getElementById('gallery-container');
        const userInfoContainer = document.getElementById('user-info-container');
        const userNameSpan = document.getElementById('user-name');
        const userPhotoImg = document.getElementById('user-photo');
        const noImagesMessage = document.getElementById('no-images-message');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const userIdDisplay = document.getElementById('user-id-display');

        // Modal elements
        const messageModal = document.getElementById('message-modal');
        const modalBackdrop = document.getElementById('modal-backdrop');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalCloseButton = document.getElementById('modal-close-button');

        // --- State Variables ---
        let userId = null;
        let isAuthReady = false;
        let unsubscribeImages = null;

        // --- Utility Functions ---
        function showLoading() { loadingIndicator.classList.remove('hidden'); }
        function hideLoading() { loadingIndicator.classList.add('hidden'); }

        function showMessage(title, message) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            messageModal.classList.remove('hidden');
            modalBackdrop.classList.remove('hidden');
        }

        function hideMessage() {
            messageModal.classList.add('hidden');
            modalBackdrop.classList.add('hidden');
        }

        // --- Authentication Logic ---
        async function handleGoogleSignIn() {
            try {
                showLoading();
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Google Sign-In failed:", error);
                showMessage("Sign-In Failed", `Error: ${error.message}`);
            } finally {
                hideLoading();
            }
        }

        async function handleSignOut() {
            try {
                await signOut(auth);
            } catch (error) {
                console.error("Sign-Out failed:", error);
                showMessage("Sign-Out Failed", `Error: ${error.message}`);
            }
        }

        // --- UI Update Function ---
        function updateUIForUser(user) {
            if (user) {
                userId = user.uid;
                authSection.classList.add('hidden');
                appSection.classList.remove('hidden');
                userInfoContainer.classList.remove('hidden');
                userNameSpan.textContent = user.displayName || 'Guest';
                userPhotoImg.src = user.photoURL || `https://ui-avatars.com/api/?name=${user.displayName || 'Guest'}&background=4f46e5&color=fff&rounded=true`;
                userIdDisplay.textContent = `User ID: ${userId}`;
                
                // Start listening to the gallery once authenticated
                if (!unsubscribeImages) {
                    listenForImages();
                }

            } else {
                userId = null;
                authSection.classList.remove('hidden');
                appSection.classList.add('hidden');
                userInfoContainer.classList.add('hidden');
                // Stop listening when the user logs out
                if (unsubscribeImages) {
                    unsubscribeImages();
                    unsubscribeImages = null;
                }
                galleryContainer.innerHTML = '';
            }
        }

        // --- Firestore Logic ---
        async function uploadImage() {
            if (!imageFile.files || imageFile.files.length === 0) {
                showMessage("No File Selected", "Please select an image file to upload.");
                return;
            }

            const file = imageFile.files[0];
            const reader = new FileReader();
            reader.onloadend = async function () {
                try {
                    showLoading();
                    const base64Data = reader.result;

                    // Firestore document path and data
                    const imagesRef = collection(db, 'images'); // Updated collection path
                    const newImageDoc = {
                        base64: base64Data,
                        uploadedBy: {
                            uid: auth.currentUser.uid,
                            name: auth.currentUser.displayName || 'Anonymous',
                            photoURL: auth.currentUser.photoURL || null
                        },
                        timestamp: Date.now(),
                    };

                    await addDoc(imagesRef, newImageDoc);
                    showMessage("Success", "Image uploaded successfully!");

                } catch (e) {
                    console.error("Error uploading image: ", e);
                    showMessage("Upload Failed", "An error occurred during image upload. The file may be too large.");
                } finally {
                    hideLoading();
                }
            };

            reader.readAsDataURL(file);
        }

        function listenForImages() {
            const imagesRef = collection(db, 'images'); // Updated collection path
            const q = query(imagesRef, orderBy("timestamp", "desc"));

            unsubscribeImages = onSnapshot(q, (querySnapshot) => {
                galleryContainer.innerHTML = '';
                const images = [];
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    images.push(data);
                });

                if (images.length === 0) {
                    noImagesMessage.classList.remove('hidden');
                } else {
                    noImagesMessage.classList.add('hidden');
                    images.forEach(data => {
                        const imgWrapper = document.createElement('div');
                        imgWrapper.className = 'relative group w-full h-auto rounded-xl overflow-hidden shadow-lg transform hover:scale-105 transition-transform duration-300';
                        
                        const img = document.createElement('img');
                        img.src = data.base64;
                        img.alt = "Uploaded image";
                        img.className = 'w-full h-auto object-cover rounded-xl';

                        const overlay = document.createElement('div');
                        overlay.className = 'absolute inset-0 bg-gradient-to-t from-gray-900 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300';
                        
                        const text = document.createElement('div');
                        text.className = 'absolute bottom-0 left-0 p-4 text-white text-sm opacity-0 group-hover:opacity-100 transition-opacity duration-300';
                        text.innerHTML = `<p class="font-semibold">${data.uploadedBy.name}</p><p class="text-xs text-gray-300">${new Date(data.timestamp).toLocaleDateString()}</p>`;

                        imgWrapper.appendChild(img);
                        imgWrapper.appendChild(overlay);
                        imgWrapper.appendChild(text);
                        galleryContainer.appendChild(imgWrapper);
                    });
                }
            }, (error) => {
                console.error("Error listening to images:", error);
                showMessage("Real-time Error", "Failed to fetch images in real-time. Please reload the page.");
            });
        }

        // --- Event Listeners ---
        window.onload = function () {
            // Initial authentication check
            onAuthStateChanged(auth, (user) => {
                isAuthReady = true;
                updateUIForUser(user);
            });
        };

        signInButton.addEventListener('click', handleGoogleSignIn);
        logoutButton.addEventListener('click', handleSignOut);
        uploadButton.addEventListener('click', uploadImage);
        modalCloseButton.addEventListener('click', hideMessage);

    </script>

</body>
</html>
